stages:
  - build
  - deploy

variables:
  IMAGE_NAME: rag:latest
  CONTAINER_NAME: rag-container

.default-docker-job: &default-docker-job
  tags:
    - vps1
  before_script:
    - echo "Running on $(hostname)"
    - docker --version

build-docker-image:
  stage: build
  tags:
    - vps1
  script:
    - cd python/rag_api
    - docker build --no-cache -t rag:latest .

deploy-in-to-docker:
  <<: *default-docker-job
  stage: deploy
  script:
    - cd python/rag_api

    # safe debug of OPENAI_API_KEY (doesn't print key)
    - |
      echo "OPENAI_API_KEY set? ${OPENAI_API_KEY:+yes}"
      echo -n "$OPENAI_API_KEY" | wc -c | xargs printf "OPENAI_API_KEY length: %s\n"
      echo -n "$OPENAI_API_KEY" | sha256sum | awk '{print "OPENAI_API_KEY sha256:", $1}'

    # create ephemeral .env for compose (compose picks it up automatically)
    - |
      cat > .env <<EOF
      OPENAI_API_KEY=${OPENAI_API_KEY}
      S3_ENDPOINT=${S3_ENDPOINT}
      S3_BUCKET_VECTORS=${S3_BUCKET_VECTORS}
      S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      EOF
      chmod 600 .env

    # bring container down (optionally remove volumes if FORCE_S3_REFRESH=1)
    - |
      if [ "${FORCE_S3_REFRESH}" = "1" ]; then
        docker compose down -v --remove-orphans || true
      else
        docker compose down --remove-orphans || true
      fi

    # start container (will use the locally-built image)
    - docker compose up -d --build

    # cleanup .env
    - shred -u .env || rm -f .env || true
