stages:
  - build
  - deploy

# small before_script anchors
.before-vps1: &before-vps1
  - echo "Running on $(hostname)"
  - docker --version || true
  - docker-compose --version || true

.before-vps2: &before-vps2
  - echo "Running on $(hostname) (golang runner)"
  - docker --version || true
  - docker-compose --version || true

variables:
  IMAGE_NAME: "rag:latest"
  CONTAINER_NAME: "rag-container"
  BOT_IMAGE_NAME: "study-bot:latest"
  BOT_CONTAINER_NAME: "study-bot"
  GOLANG_IMAGE_NAME: "golang-agent:latest"
  GOLANG_CONTAINER_NAME: "golang-agent"

################################################################################
# RAG (python/rag_api)
################################################################################
build-rag-image:
  stage: build
  tags:
    - vps1
  before_script: *before-vps1
  script:
    - cd python/rag_api
    - docker build --no-cache -t "${IMAGE_NAME}" .

deploy-rag:
  stage: deploy
  tags:
    - vps1
  before_script: *before-vps1
  script:
    - cd python/rag_api
    - 'echo "OPENAI_API_KEY set? ${OPENAI_API_KEY:+yes}"'
    - 'echo "OPENAI_API_KEY length: ${#OPENAI_API_KEY}"'
    - 'printf "OPENAI_API_KEY=%s\n" "${OPENAI_API_KEY}" > .env'
    - 'printf "S3_ENDPOINT=%s\n" "${S3_ENDPOINT}" >> .env'
    - 'printf "S3_BUCKET_VECTORS=%s\n" "${S3_BUCKET_VECTORS}" >> .env'
    - 'printf "S3_ACCESS_KEY_ID=%s\n" "${S3_ACCESS_KEY_ID}" >> .env'
    - 'printf "S3_SECRET_ACCESS_KEY=%s\n" "${S3_SECRET_ACCESS_KEY}" >> .env'
    - chmod 600 .env
    - 'if [ "${FORCE_S3_REFRESH}" = "1" ]; then docker-compose down -v --remove-orphans || true; else docker-compose down --remove-orphans || true; fi'
    - docker-compose up -d --build
    - 'shred -u .env || rm -f .env || true'

################################################################################
# BOT (study-bot)
################################################################################
build-bot-image:
  stage: build
  tags:
    - vps1
  before_script: *before-vps1
  rules:
    - exists:
        - Dockerfile
        - docker-compose.yml
  script:
    - docker build --no-cache -t "${BOT_IMAGE_NAME}" .

deploy-bot:
  stage: deploy
  tags:
    - vps1
  before_script: *before-vps1
  rules:
    - exists:
        - Dockerfile
        - docker-compose.yml
  script:
    - 'echo "OPENAI_API_KEY set? ${OPENAI_API_KEY:+yes}"'
    - 'echo "OPENAI_API_KEY length: ${#OPENAI_API_KEY}"'
    - 'printf "OPENAI_API_KEY=%s\n" "${OPENAI_API_KEY}" > .env'
    - 'printf "S3_ENDPOINT=%s\n" "${S3_ENDPOINT}" >> .env'
    - 'printf "S3_BUCKET=%s\n" "${S3_BUCKET}" >> .env'
    - 'printf "S3_ACCESS_KEY_ID=%s\n" "${S3_ACCESS_KEY_ID}" >> .env'
    - 'printf "S3_SECRET_ACCESS_KEY=%s\n" "${S3_SECRET_ACCESS_KEY}" >> .env'
    - chmod 600 .env
    - 'if [ "${FORCE_S3_REFRESH}" = "1" ]; then docker-compose down -v --remove-orphans || true; else docker-compose down --remove-orphans || true; fi'
    - docker-compose up -d --build
    - 'shred -u .env || rm -f .env || true'

################################################################################
# GOLANG service (runs ONLY after deploy-rag)
################################################################################
build-golang-image:
  stage: build
  tags:
    - vps2
  before_script: *before-vps2
  script:
    - cd golang
    - docker build --no-cache -t "${GOLANG_IMAGE_NAME}" .

deploy-golang:
  stage: deploy
  tags:
    - vps2
  before_script: *before-vps2
  needs:
    - job: deploy-rag
      optional: false
  script:
    - cd golang
    - 'printf "S3_ENDPOINT=%s\n" "${S3_ENDPOINT}" > .env'
    - 'printf "S3_BUCKET=%s\n" "${S3_BUCKET}" >> .env'
    - 'printf "S3_ACCESS_KEY_ID=%s\n" "${S3_ACCESS_KEY_ID}" >> .env'
    - 'printf "S3_SECRET_ACCESS_KEY=%s\n" "${S3_SECRET_ACCESS_KEY}" >> .env'
    - 'printf "OPENAI_API_KEY=%s\n" "${OPENAI_API_KEY}" >> .env'
    - chmod 600 .env
    - 'if [ "${FORCE_S3_REFRESH}" = "1" ]; then docker-compose down -v --remove-orphans || true; else docker-compose down --remove-orphans || true; fi'
    - docker-compose up -d --build
    - 'shred -u .env || rm -f .env || true'
