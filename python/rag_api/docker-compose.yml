version: "3.8"

services:
  rag_api:
    # In local/dev, docker-compose can build from the Dockerfile in python/rag_api
    build:
      context: ./python/rag_api
      dockerfile: Dockerfile
    # In production/deploy we will prefer pulling from the registry; the CI deploy uses IMAGE env to override
    image: "${IMAGE:-registry.example.com/${CI_PROJECT_PATH}/rag_api:latest}"
    container_name: rag_api
    restart: unless-stopped
    env_file:
      - .env         
    environment:
      # runtime environment (add more as needed). These will be read from .env or CI env.
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET_VECTORS=${S3_BUCKET_VECTORS}
      - S3_USE_SSL=${S3_USE_SSL}
      - OUT_DIR=/app/out
    ports:
      - "8000:8000"
    volumes:
      - ./python/RAG/out:/app/out   # Persist/downloaded artifacts and index
      - ./python:/app               # Mount code for hot-reload in dev (optional)
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -fsS http://localhost:8000/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
