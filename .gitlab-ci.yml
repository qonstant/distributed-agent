stages:
  - build
  - deploy

variables:
  IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"

build:
  stage: build
  tags:
    - "first"
  image:
    name: gcr.io/kaniko-project/executor:latest
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - |
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR/python/rag_api --dockerfile $CI_PROJECT_DIR/python/rag_api/Dockerfile --destination $IMAGE --skip-tls-verify=false
  rules:
    - if: $CI_COMMIT_BRANCH
  artifacts:
    expire_in: 1h
    reports: {}

deploy:
  stage: deploy
  tags:
    - "first"
  image:
    name: lachlanevenson/k8s-helm:latest
    entrypoint: [""]
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG" > ~/.kube/config
    - helm version
  script:
    - kubectl create namespace default || true
    - helm upgrade --install rag-api charts/rag-api \
        --namespace default \
        --set image.repository="$CI_REGISTRY_IMAGE" \
        --set image.tag="$CI_COMMIT_SHORT_SHA" \
        --wait
  rules:
    - if: $CI_COMMIT_BRANCH
