# .gitlab-ci.yml (no-docker deployment on host via systemd)
stages:
  - smoke
  - deploy

smoke_python_check:
  stage: smoke
  tags:
    - vps1
  when: manual
  allow_failure: true
  script:
    - 'echo "Python version:"; python3 --version'
    - 'python3 -m venv .venv_ci || true'
    - '. .venv_ci/bin/activate && pip install -r python/rag_api/requirements.txt'
    - '. .venv_ci/bin/activate && python -c "import uvicorn,faiss,numpy; print(\"imports_ok\")" || echo "import check failed"'

deploy_to_system:
  stage: deploy
  tags:
    - vps1
  when: manual
  script:
    - 'echo "Copying files to /opt/distributed-agent (requires runner user permissions)"'
    - 'sudo rm -rf /opt/distributed-agent || true'
    - 'sudo mkdir -p /opt/distributed-agent'
    - 'sudo cp -r . /opt/distributed-agent'
    - 'echo "Restarting rag_api systemd service (create unit file if not present)"'
    - 'sudo systemctl daemon-reload || true'
    - 'sudo systemctl restart rag_api.service || sudo systemctl start rag_api.service || true'
    - 'sudo journalctl -u rag_api.service --no-pager -n 200 || true'
  only:
    - main
